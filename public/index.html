<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Table Data Searching — Fullstack (stories, fuzzy, edit, avatars)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .match { background: #ffeb3b; padding: 0 2px; border-radius: 2px; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:after { content: " \u2195"; color: #fff; font-weight: 400; margin-left: 6px; }
    th.sortable.asc:after { content: " \u2191"; }
    th.sortable.desc:after { content: " \u2193"; }
    .name-link { color: inherit; text-decoration: underline; cursor: pointer; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .avatar-lg { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
    .preview-row td { background: #f8f9fa; }
    .controls { display:flex; gap:8px; align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <main class="container mt-4 pb-5 pt-4" style="background: #d9ebfa; border-radius: 12px;">
    <div class="row">
      <div class="offset-md-1 col-md-10 d-flex gap-2 align-items-center">
        <input id="search" class="form-control" type="search" placeholder="Search — try name, country, city, id, or story" aria-label="Live search table">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="fuzzyToggle">
          <label class="form-check-label" for="fuzzyToggle">Fuzzy (client)</label>
        </div>
        <button id="loginBtn" class="btn btn-outline-primary btn-sm">Admin Login</button>
        <div id="loggedInBadge" style="display:none;" class="badge bg-success">Admin</div>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-12 text-center">
        <small id="summary" class="text-muted"></small>
        <div id="spinner" class="spinner-border text-primary" role="status" style="display:none; width:1rem; height:1rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="offset-md-1 col-md-10">
        <div class="table-responsive">
          <table id="mytable" class="table table-bordered border-primary table-hover text-capitalize"></table>
        </div>

        <nav aria-label="Pagination" class="mt-3">
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </main>

  <!-- Story modal (view + edit) -->
  <div class="modal fade" id="storyModal" tabindex="-1" aria-labelledby="storyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="storyModalLabel">Story</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="storyModalBody">
          <!-- dynamic -->
        </div>
        <div class="modal-footer">
          <div class="me-auto" id="storyModalMeta"></div>
          <div class="controls">
            <button id="editBtn" type="button" class="btn btn-sm btn-outline-secondary" style="display:none;">Edit</button>
            <button id="saveBtn" type="button" class="btn btn-sm btn-primary" style="display:none;">Save</button>
            <button id="cancelEditBtn" type="button" class="btn btn-sm btn-secondary" style="display:none;">Cancel</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login prompt modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Admin Login</h5></div>
        <div class="modal-body">
          <div class="mb-2">
            <label for="passwordInput" class="form-label visually-hidden">Password</label>
            <input id="passwordInput" class="form-control" type="password" placeholder="Enter admin password">
          </div>
          <div id="loginError" class="text-danger small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button id="doLoginBtn" class="btn btn-primary btn-sm">Login</button>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = '/api/users';
    const columns = ['avatar','id','name','country','city','actions'];
    let state = { page: 1, limit: 8, sort: 'id', dir: 'asc', search: '' };
    let adminToken = localStorage.getItem('admin_token') || null;
    let isAdmin = !!adminToken;
    let fuseIndex = null;
    let allUsersCache = null;

    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function highlight(text, terms) {
      if (!terms || terms.length === 0) return escapeHtml(text);
      let safe = escapeHtml(text);
      for (const t of terms) {
        if (!t) continue;
        try {
          const re = new RegExp(t.replace(/[.*+?^${}()|[\\]\]/g,'\\$&'), 'gi');
          safe = safe.replace(re, match => `<span class="match">${escapeHtml(match)}</span>`);
        } catch (e) {}
      }
      return safe;
    }
    function showSpinner(on) { document.getElementById('spinner').style.display = on ? 'inline-block' : 'none'; }

    function setAdminToken(token) {
      adminToken = token;
      localStorage.setItem('admin_token', token || '');
      isAdmin = !!token;
      document.getElementById('loggedInBadge').style.display = isAdmin ? 'inline-block' : 'none';
    }
    if (isAdmin) document.getElementById('loggedInBadge').style.display = 'inline-block';

    async function fetchData() {
      showSpinner(true);
      const fuzzyEnabled = document.getElementById('fuzzyToggle').checked;
      const q = state.search.trim();
      try {
        if (fuzzyEnabled && q.length > 0) {
          if (!allUsersCache) {
            const resAll = await fetch('/api/users/all');
            if (!resAll.ok) throw new Error('Failed to load all users for fuzzy search');
            allUsersCache = await resAll.json();
            fuseIndex = new Fuse(allUsersCache, {
              keys: ['name', 'story', 'city', 'country'],
              threshold: 0.35,
              ignoreLocation: true,
              minMatchCharLength: 2
            });
          }
          const fuseRes = fuseIndex.search(q, { limit: 200 });
          const total = fuseRes.length;
          const start = (state.page - 1) * state.limit;
          const paged = fuseRes.slice(start, start + state.limit).map(r => r.item);
          renderTable(paged, q);
          renderPagination(total, state.page, state.limit);
          document.getElementById('summary').textContent = \
            `${total} result${total !== 1 ? 's' : ''} (fuzzy)`;
        } else {
          const params = new URLSearchParams({
            search: state.search,
            page: state.page,
            limit: state.limit,
            sort: state.sort,
            dir: state.dir
          });
          const res = await fetch(`${API}?${params.toString()}`);
          if (!res.ok) throw new Error('Network error');
          const json = await res.json();
          renderTable(json.results, state.search);
          renderPagination(json.total, json.page, json.limit);
          document.getElementById('summary').textContent = `${json.total} result${json.total !== 1 ? 's' : ''}`;
        }
      } catch (err) {
        console.error(err);
        document.getElementById('mytable').innerHTML = `<tr><td colspan="${columns.length}">Error loading data</td></tr>`;
      } finally {
        showSpinner(false);
      }
    }

    function renderTable(rows, searchTerm) {
      const terms = searchTerm.trim().toLowerCase().split(/\s+/).filter(Boolean);
      let html = `<thead><tr class="bg-primary text-white fw-bold">`;
      html += `<th></th>`; // avatar
      html += `<th>ID</th>`;
      html += `<th>NAME</th>`;
      html += `<th>COUNTRY</th>`;
      html += `<th>CITY</th>`;
      html += `<th></th>`;
      html += `</tr></thead><tbody>`;

      if (!rows || rows.length === 0) {
        html += `<tr><td colspan="${columns.length}" class="text-center">No results</td></tr>`;
      } else {
        for (const r of rows) {
          const idEsc = escapeHtml(r.id);
          const photo = r.photo || `https://i.pravatar.cc/150?u=${idEsc}`;
          html += `<tr data-id="${idEsc}">
            <td style="width:56px"><img src="${escapeHtml(photo)}" class="avatar" alt="${escapeHtml(r.name)}"></td>
            <td>${highlight(r.id, terms)}</td>
            <td><span class="name-link" data-id="${idEsc}" role="button" tabindex="0">${highlight(r.name, terms)}</span></td>
            <td>${highlight(r.country, terms)}</td>
            <td>${highlight(r.city, terms)}</td>
            <td style="width:120px">
              <button class="btn btn-sm btn-outline-secondary expandBtn">View</button>
              <button class="btn btn-sm btn-outline-info ms-1 storyBtn">Story</button>
            </td>
          </tr>
          <tr class="preview-row" data-preview-for="${idEsc}" style="display:none;">
            <td colspan="${columns.length}">
              <div class="d-flex gap-3 align-items-start">
                <img src="${escapeHtml(photo)}" class="avatar-lg" alt="${escapeHtml(r.name)}">
                <div class="preview-text"><em>Loading preview…</em></div>
              </div>
            </td>
          </tr>`;
        }
      }
      html += `</tbody>`;
      document.getElementById('mytable').innerHTML = html;

      // Attach handlers: sort headers
      document.querySelectorAll('#mytable th').forEach((th, idx) => {
        if (idx === 0 || idx === 5) return; // don't sort by avatar or actions
        th.classList.add('sortable');
        th.setAttribute('data-col', ['id','name','country','city'][idx-1]);
        th.addEventListener('click', () => {
          const col = th.getAttribute('data-col');
          if (state.sort === col) state.dir = state.dir === 'asc' ? 'desc' : 'asc';
          else { state.sort = col; state.dir = 'asc'; }
          fetchData();
        });
        th.setAttribute('tabindex','0');
        th.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); th.click(); } });
      });

      // Expand/collapse preview row
      document.querySelectorAll('.expandBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          const previewRow = document.querySelector(`tr[data-preview-for="${id}"]`);
          const shown = previewRow.style.display !== 'none';
          if (shown) { previewRow.style.display = 'none'; btn.textContent = 'View'; }
          else {
            const previewText = previewRow.querySelector('.preview-text');
            if (previewText && previewText.textContent.includes('Loading')) {
              try {
                const res = await fetch(`${API}/${encodeURIComponent(id)}`);
                if (!res.ok) throw new Error('Not found');
                const user = await res.json();
                const snippet = (user.story || '').slice(0, 350);
                previewText.innerHTML = `<strong>${escapeHtml(user.name)}</strong><p>${escapeHtml(snippet)}${(user.story||'').length > 350 ? '…' : ''}</p>`;
              } catch (err) { previewText.innerHTML = `<em>Unable to load preview.</em>`; }
            }
            previewRow.style.display = '';
            btn.textContent = 'Hide';
          }
        });
      });

      // Story modal open
      document.querySelectorAll('.storyBtn, .name-link').forEach(el => {
        el.addEventListener('click', (e) => {
          const id = el.getAttribute('data-id');
          openStoryModalFor(id);
        });
        el.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click(); } });
      });
    }

    function renderPagination(total, page, limit) {
      const pages = Math.max(1, Math.ceil(total / limit));
      const ul = document.getElementById('pagination');
      ul.innerHTML = '';
      const makeLi = (content, disabled, onClick, active) => {
        const li = document.createElement('li');
        li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
        const btn = document.createElement('button');
        btn.className = 'page-link';
        btn.type = 'button';
        btn.innerHTML = content;
        if (!disabled && onClick) btn.addEventListener('click', onClick);
        li.appendChild(btn);
        return li;
      };
      ul.appendChild(makeLi('Previous', page === 1, () => { state.page = Math.max(1, state.page - 1); fetchData(); }));
      const start = Math.max(1, page - 2);
      const end = Math.min(pages, page + 2);
      for (let p = start; p <= end; p++) ul.appendChild(makeLi(String(p), false, () => { state.page = p; fetchData(); }, p === page));
      ul.appendChild(makeLi('Next', page === pages, () => { state.page = Math.min(pages, state.page + 1); fetchData(); }));
    }

    async function openStoryModalFor(id) {
      if (!id) return;
      const modalEl = document.getElementById('storyModal');
      const bsModal = new bootstrap.Modal(modalEl);
      const body = document.getElementById('storyModalBody');
      const title = document.getElementById('storyModalLabel');
      const meta = document.getElementById('storyModalMeta');
      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');

      title.textContent = 'Loading...';
      body.innerHTML = '';
      meta.textContent = '';
      editBtn.style.display = isAdmin ? '' : 'none';
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';

      bsModal.show();

      try {
        const res = await fetch(`${API}/${encodeURIComponent(id)}`);
        if (!res.ok) { title.textContent = 'Not found'; body.textContent = 'No story found for this user.'; return; }
        const user = await res.json();
        title.textContent = \
          `${user.name} — Story`;
        const storyText = String(user.story || 'No story provided.');
        body.innerHTML = `<div id="storyText">${escapeHtml(storyText).replace(/\n/g, '<br>')}</div>`;
        meta.innerHTML = `<img src="${escapeHtml(user.photo || '')}" class="avatar-lg me-2" style="vertical-align:middle;"> ${escapeHtml(user.city || '')} ${user.country ? ' • ' + escapeHtml(user.country) : ''}`;

        let editing = false;
        editBtn.onclick = () => {
          if (!isAdmin) return alert('Admin only');
          editing = true;
          const current = storyText;
          body.innerHTML = `<textarea id="storyEditor" class="form-control" rows="8">${escapeHtml(current)}</textarea>`;
          editBtn.style.display = 'none';
          saveBtn.style.display = '';
          cancelBtn.style.display = '';
        };

        cancelBtn.onclick = () => {
          editing = false;
          body.innerHTML = `<div id="storyText">${escapeHtml(storyText).replace(/\n/g, '<br>')}</div>`;
          editBtn.style.display = isAdmin ? '' : 'none';
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
        };

        saveBtn.onclick = async () => {
          const newText = document.getElementById('storyEditor').value;
          saveBtn.disabled = true;
          try {
            const resu = await fetch(`${API}/${encodeURIComponent(id)}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': adminToken ? `Bearer ${adminToken}` : ''
              },
              body: JSON.stringify({ story: newText })
            });
            if (!resu.ok) {
              if (resu.status === 401) { alert('Unauthorized. Please log in as admin.'); }
              else { const err = await resu.json().catch(()=>({error:'unknown'})); alert('Error saving: ' + (err.error || resu.statusText)); }
            } else {
              editing = false;
              body.innerHTML = `<div id="storyText">${escapeHtml(newText).replace(/\n/g, '<br>')}</div>`;
              editBtn.style.display = isAdmin ? '' : 'none';
              saveBtn.style.display = 'none';
              cancelBtn.style.display = 'none';
              if (allUsersCache) {
                const idx = allUsersCache.findIndex(u => u.id === id);
                if (idx !== -1) { allUsersCache[idx].story = newText; if (fuseIndex) fuseIndex.setCollection(allUsersCache); }
              }
            }
          } catch (err) { console.error(err); alert('Error saving story'); } finally { saveBtn.disabled = false; }
        };
      } catch (err) { console.error(err); title.textContent = 'Error'; body.textContent = 'Unable to load story.'; }
    }

    const loginBtn = document.getElementById('loginBtn');
    const loginModalEl = document.getElementById('loginModal');
    const loginModal = new bootstrap.Modal(loginModalEl);
    loginBtn.addEventListener('click', () => { document.getElementById('passwordInput').value = ''; document.getElementById('loginError').style.display='none'; loginModal.show(); });

    document.getElementById('doLoginBtn').addEventListener('click', async () => {
      const pwd = document.getElementById('passwordInput').value;
      document.getElementById('loginError').style.display='none';
      try {
        const res = await fetch('/api/login', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pwd }) });
        if (!res.ok) { const err = await res.json().catch(()=>({error:'login failed'})); document.getElementById('loginError').textContent = err.error || 'Login failed'; document.getElementById('loginError').style.display = ''; return; }
        const json = await res.json();
        setAdminToken(json.token);
        loginModal.hide();
      } catch (err) { console.error(err); document.getElementById('loginError').textContent = 'Login failed'; document.getElementById('loginError').style.display = ''; }
    });

    function debounce(fn, wait) { let t; return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); }; }

    document.getElementById('search').addEventListener('input', debounce(function(e) { state.search = e.target.value; state.page = 1; fetchData(); }, 250));

    document.getElementById('fuzzyToggle').addEventListener('change', () => { state.page = 1; fetchData(); });

    fetchData();
  </script>
</body>
</html>
